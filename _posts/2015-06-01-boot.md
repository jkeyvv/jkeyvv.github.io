---
layout: post
title: 计算机开机过程详解
category: 技术
tags: 引导，开机
description: 
---

“您本次开机用时45秒，击败了全国60%的电脑！”，这句话相信大家都很熟悉，不过大家有没有想过，在这短短的45秒内发生了什么，电脑是如何由一台冰冷的机器变成一个丰富多彩的世界？今天我就和大家一起来探索开机之旅。

## BIOS


在你按下电源按钮的那一刻，一个存储在主板上正方形小芯片里的程序马上就开始运行了，这个程序就是BIOS(Basic Input Output System)，不过现在BIOS正在逐步被UEFI(Unified Extensible Firmware Interface)所取代。

### BIOS与CMOS介绍

BIOS直译成中文是“基本输入输出系统”，作为开机第一程序，它有着具足轻重的作用，现在就有专门针对BIOS的病毒，号称“计算机界的埃博拉”。BIOS固化在主板上的一块ROM(Read Only Memory)里，所谓ROM，就是只读存储器，与RAM(Random Access Memory)不同，存放在ROM里面的程序不会因为断电而消失，正因如此我们才可以优雅地反复开关机。BIOS里面存储着计算机最重要的基本输入输出的程序、开机后自检程序和系统自启动程序，它可从CMOS中读写系统设置的具体信息。在开机开始时，可以按< F2 >或者< del >（机器不同，按键可能不同）对BIOS进行设置，如果不了解各个选项的意义最好不要随便更改，否则可能造成开机异常甚至硬件故障。

下面说一下CMOS，它也是主板上的一块芯片，但它是RAM，由一块电池供电(拆过主板的应该见过），CMOS里保存着BIOS的硬件配置和计算机的基本信息，它仅仅是用来存放信息的。因为BIOS和CMOS关系密切，经常一起出现，所以许多人经常把它们搞混。

### BIOS工作流程

BIOS的工作流程是这样的，首先，BIOS进行一个称之为上电自检（POST，Power on Self Test）的过程，这一过程将对计算机的主要硬件进行检测，期间若果出现问题，主板会发出不同含义的蜂鸣，通知用户故障出在哪里，并停止启动。如果没有问题，屏幕上会显示CPU、内存等硬件信息。然后，BIOS将按照系统CMOS中设置的启动顺序去寻找能够开机的存储器，读取存储器的开始的512个字节（MBR，主引导记录）， 将这512个字节的内容放到内存`0x7c00`的位置，接着BIOS会看它们最后两个字节是不是`0x55`和`0xaa`，如果不是，就继续对下一存储器实施这一过程，如果存储器没有能够启动的，就会在屏幕打印出“No Boot......”之类的东西。如果找到了能够启动的存储器，BIOS就将系统控制权交给主引导记录里面的引导程序，此时BIOS的任务就结束了。

>除了上电自检和加载主引导记录外，BIOS还包含系统设置程序和中断服务程序，这里不作赘述。

## 主引导记录

我们都知道磁盘是由一个个扇区构成的，每个扇区的大小都是固定的512字节。在这些扇区中，第0磁头0柱面1扇区称为主引导扇区，里面的内容称为MBR（Master Boot Record，主引导记录），它由三部分组成：

- 第1-446字节：引导代码
- 第447-510字节：分区表（Partition table）
- 第511-512字节：结束标志（0x55和0xaa，魔数）

### 分区表

先拿分区表开刀，装过系统的应该都知道分区，分完之后的C盘、D盘啥的更是经常说到，那么什么是分区呢？用刀割开吗？当然不是，磁盘又不是西瓜。其实分区全靠这个分区表，这小小的64B。这64B分为四部分，每部分16字节，记录了一个分区的基本信息，这16字节的内容如下：

- 0 Activeflag活动标志，若为0x80H，则表示该分区为活动分区，若为0x00H，则表示该分区为非活动分区

- 1-3 该分区的起始磁头号，扇区号，柱面号。其中：

	- 磁头号第1字节
	- 扇区号第2字节的低6位
	- 柱面号第2字节的高2位+第3字节

- 4 分区文件系统标志：
	- 分区未用：0x00H
	- 扩展分区：0x05H，0x0FH
	- FAT16分区：0x06H
	- FAT32分区：0x0BH，0x1BH，0x0CH，0x1CH
	- NTFS分区：0x07H

- 5-7 该分区的结束磁头号，扇区号，柱面号，含义同上

- 8-11 逻辑起始扇区号，表示分区起点之前已用了的扇区数

- 12-15 该分区所占用的扇区数

这时有人该问了：4个？我的磁盘分了5个区啊？这里面就有说道了：

分区主分区和扩展分区之别，扩展分区最多只能有1个，主分区和扩展分区的总数不能超过4个（GPT分区表除外），所以MBR里记录的分区都是主分区和扩展分区。扩展分区之所以叫扩展分区就在于它可以分成好多逻辑分区，逻辑分区的信息记录在EBR（扩展引导记录）。上面第4个字节说明了一个分区是否是扩展分区。

另外，需要注意的是，第4个字节表明了一个分区的文件系统是哪种，这里只有Windows使用的文件系统，目前Linux用的是Ext4。同时，Linux各个分区不叫“x盘”，叫sda1、sda2等，其中逻辑分区只能从sda5开始，不管前面有几个主分区。 

### 引导代码

引导代码里面包含了引导程序，它负责将BIOS交给它的系统控制权转交给分区的启动扇区，而且只能交给活动标志为`0x80H`的分区（比如Windows的C盘）。它先判断活动分区的引导扇区在磁盘中的地址，并将该引导扇区读入内存判断其合法性，如果是一个合法的引导扇区，随后的引导权就交给这个引导扇区去引导系统了，MRB引导程序的使命也就完成的。 

还有一个问题就是多重引导的问题，我们知道可以在不同的分区中安装不同的操作系统，这样就会有不止一个活动分区。但是引导程序并不会因此纠结，它会把选择权交给用户，通常会有一个叫启动管理器（如Easy bcd、Grub） 的软件，以图形界面的形式让用户启动其中一个系统。

>如果装Windows和Linux的双系统，一定要先装Windows，否则后装的Windows会覆盖MBR，使Linux无法启动。

## 最后

当控制权交给启动扇区后，启动扇区会将操作系统的核心程序放到内存中执行，这时体现的就是操作系统之间的差别了，有空再更新这部分内容。