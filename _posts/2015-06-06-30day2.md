---
layout: post
title: 自制操作系统(2)—汇编语言与Makefile
category: 技术
tags: 操作系统 
description: 30天自制操作系统第二天
---

接着昨天的内容，先来看看那段程序的主体部分，下面是完整的汇编语言：

    ; hello-os
	; TAB=4
	
			ORG		0x7c00			; 指明程序的装载地址
	
	; 以下的记述适用于标准FAT12格式的软盘
	
			JMP		entry
			DB		0x90
			DB		"HELLOIPL"	
				
	; ------------省略------------
	
			DB		"FAT12   "
			RESB	18
	
	; 程序核心
	
	entry:
			MOV		AX,0			; 初始化寄存器
			MOV		SS,AX
			MOV		SP,0x7c00
			MOV		DS,AX
			MOV		ES,AX
	
			MOV		SI,msg
	putloop:
			MOV		AL,[SI]
			ADD		SI,1			; 给SI加1
			CMP		AL,0
			JE		fin
			MOV		AH,0x0e			; 显示一个文字
			MOV		BX,15			; 指定字符颜色
			INT		0x10			; 调用显卡BIOS
			JMP		putloop
	fin:
			HLT						; 让CPU停止，等待指令
			JMP		fin				; 无限循环
	
	msg:
			DB		0x0a, 0x0a		; 换行2次
			DB		"hello, world"
			DB		0x0a			; 换行
			DB		0
	; ---------------省略-------------------
			RESB	0x7dfe-$
	
			DB		0x55, 0xaa

开头的ORG指明程序会在内存中偏移地址0x7c00处开始执行，我在[计算机启动过程详解]({% post_url 2015-06-01-boot %})中提到过，这正是BIOS将控制权交给引导程序的地方。程序的核心部分调用了16号BIOS中断，依次在屏幕上输出事先存放在msg处的字符。等到所有字符输出完毕，跳转到HLT指令处，HLT指令的作用是使程序停止运行，处理器进入暂停状态，不执行任何操作，也不影响标志位，就像待机一样。

现在我们明白了hello world是如何显示出来的了。

接下来的内容是关于Makefile的，说实话我还是头一次知道Win上也有make，make是自动化的编译工具，推荐一篇文章[跟我一起写Makefile](http://blog.csdn.net/haoel/article/details/2886)，写得很好。Win上的Makefile跟Linux上的差不多，连斜杠都是正的，这部分就直接跳过了。

为了制作这个操作系统，作者自己写了好多软件，包括汇编编译器和生成磁盘映像的工具，确实流弊，更流弊的是这些工具目前在我的Win8 x64上竟然还都能用！