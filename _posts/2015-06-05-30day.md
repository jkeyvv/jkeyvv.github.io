---
layout: post
title: 自制操作系统(1)—从计算机结构到汇编程序
category: 技术
tags: 操作系统 
description: 30天自制操作系统第一天
---
谈到计算机，人们总要说起操作系统，什么Windows，Linux，Mac osx。。一大堆，在人们的印象中操作系统是很复杂的东西，动不动就几个G，每次安装也得花个几十分钟。实际上，用户在使用计算机时并不需要直接面对操作系统，用户面对的事安装在操作系统上的各种各样的软件，操作系统负责给各种应用软件提供硬件接口，并按应用软件的需求分配合理的硬件资源，从而使计算机的资源最大限度地发挥作用。

操作系统这么刁！这么刁的东西怎么自制啊，扯呢吧？没错，让我来做确实有点扯，但是有高人呐，岛国有个编程天才叫川合秀石，闲得没事就开发了一个迷你的操作系统，还写了本书，叫《30天自制操作系统》，我打算跟这大神进修一下，按这本书上的方法和进度模仿着也整一个，这一系列文章就算是学习笔记了。俗话说最好的学习方法是实践，看书八百遍不如手上过一遍，咱们说干就干。

作者不墨迹，一上来用二进制编辑器就开写，内容是这样的：

```
	DB	0xeb, 0x4e, 0x90, 0x48, 0x45, 0x4c, 0x4c, 0x4f
	DB	0x49, 0x50, 0x4c, 0x00, 0x02, 0x01, 0x01, 0x00
	DB	0x02, 0xe0, 0x00, 0x40, 0x0b, 0xf0, 0x09, 0x00
	DB	0x12, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00
	DB	0x40, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x29, 0xff
	DB	0xff, 0xff, 0xff, 0x48, 0x45, 0x4c, 0x4c, 0x4f
	DB	0x2d, 0x4f, 0x53, 0x20, 0x20, 0x20, 0x46, 0x41
	DB	0x54, 0x31, 0x32, 0x20, 0x20, 0x20, 0x00, 0x00
	RESB	16
	DB	0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
	DB	0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
	DB	0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
	DB	0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
	DB	0xee, 0xf4, 0xeb, 0xfd, 0x0a, 0x0a, 0x68, 0x65
	DB	0x6c, 0x6c, 0x6f, 0x2c, 0x20, 0x77, 0x6f, 0x72
	DB	0x6c, 0x64, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	368
	DB	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x55, 0xaa
	DB	0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	4600
	DB	0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	1469432
```

懂的人一看就知道，这不汇编吗？没错，因为二进制编辑器里用的也是十六进制，用汇编写出来方便一点，作者后边也是用汇编写的。这里一共是1440KB的内容，注意前512个字节，它们以`0x55`和`0xaa`结束，记得我在另一篇文章[计算机开机过程详解]({% post_url 2015-06-01-boot %})里说过，这是512个字节就是MBR（主引导记录）的内容。这说明作者在MBR里面写了个引导程序，引导程序的内容就是显示hello world。作者说把它们写入软盘就能启动计算机，让屏幕上出现hello world，但是这年代软盘早就绝迹了，我又没有光盘，就试着往U盘里写，可惜并没成功。还好作者提供了qemu这个软件，这是个虚拟机软件，而且是开源的，现在发展的很好很强大。作者为了方便广大读者，使用windows批处理文件（.bat后缀，类似于shell脚本）简化了大部分的操作，良心大大的好啊！用qemu运行后的情况如下，熟悉的hello world：

![](http://7xikhf.com1.z0.glb.clouddn.com/qemu.png)

的确是成功运行了，那这段汇编到底是啥意思啊？别着急，先看看下面这段带注释的代码：

	; hello-os
	; TAB=4
	; 以下这段是标准的FAT12格式专用的代码（有年头了-_-!）

	DB		0xeb, 0x4e, 0x90
	DB		"HELLOIPL"		; 启动区的名称可以是任意的字符串（8字节）
	DW		512				; 每个扇区（sector）的大小（必须为512字节）
	DB		1				; 簇（cluster）的大小（必须为1个扇区）
	DW		1				; FAT的起始位置（一般从第一个扇区开始）
	DB		2				; FAT的个数（必须为2）
	DW		224				; 根目录的大小（一般设成224项）
	DW		2880			; 该磁盘的大小（必须是2880扇区）
	DB		0xf0			; 磁盘的种类（必须是0xf0)
	DW		9				; FAT的长度（必须是9扇区）
	DW		18				; 一个磁道（track）有几个扇区（必须是18）
	DW		2				; 磁头数（必须是2）
	DD		0				; 不使用分区，必须是0
	DD		2880			; 重写一次磁盘大小
	DB		0,0,0x29		; 意义不明，固定
	DD		0xffffffff		; （可能是）卷标号码
	DB		"HELLO-OS   "	; 磁盘的名称（11字节）
	DB		"FAT12   "		; 磁盘格式名称（8字节）
	RESB	18				; 空出18字节

	; 程序主体

	DB		0xb8, 0x00, 0x00, 0x8e, 0xd0, 0xbc, 0x00, 0x7c
	DB		0x8e, 0xd8, 0x8e, 0xc0, 0xbe, 0x74, 0x7c, 0x8a
	DB		0x04, 0x83, 0xc6, 0x01, 0x3c, 0x00, 0x74, 0x09
	DB		0xb4, 0x0e, 0xbb, 0x0f, 0x00, 0xcd, 0x10, 0xeb
	DB		0xee, 0xf4, 0xeb, 0xfd

	; 信息显示部分

	DB		0x0a, 0x0a		; 2个换行
	DB		"hello, world"
	DB		0x0a			; 换行
	DB		0

	RESB	0x1fe-$			; 填写0x00，直到0x001fe

	DB		0x55, 0xaa

	; 下面是启动区以外部分的输出

	DB		0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	4600
	DB		0xf0, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00
	RESB	1469432

>吐个槽，话说光盘里带的源码我一打开就傻眼了，注释全是日文的，我看片少，你可别逗我。不过书上的注释是汉语的，这是我照着书上的翻译敲上去的。

观察程序前半部分，发现这是对主引导扇区做的一些初始化设置，大多是关于磁盘格式的，我觉得不用深究，因为作者还有“意义不明”的呢，说明这部分并不是很重要，另外作者的软盘也过于老旧了。接下来是程序的主体部分，留作明天再看。
